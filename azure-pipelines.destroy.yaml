name: Azure Pipelines

trigger:
- main

variables:
  python.version: '3.7.6'
  terraform.version: '0.13.4'
  # ToDo: Replace the service connection name as used in the DevOps project settings
  azureServiceConnectionId: 'adoconnection'
  # Project root folder. Point to the folder containing manage.py file.
  projectRoot: $(System.DefaultWorkingDirectory)
  # Environment name
  environmentName: 'test'

stages:
  -stage: Init
   displayName: TerraformInitialize
   jobs:
   - job: TerraformInit
     pool: myPool
     displayName: 'Terraform Initialize'
    - task: TerraformInstaller@0
      displayName: Install Terraform
      inputs:
        terraformVersion: '1.5.4'
    - task: TerraformTaskV4@4
      displayName: Terraform Destroy
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'adoconnection'
        backendAzureRmResourceGroupName: 'project3rg'
        backendAzureRmStorageAccountName: 'sa129107626'
        backendAzureRmContainerName: 'container'
        backendAzureRmKey: 'test.terraform.tfstate'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV3@3
      displayName: Terraform validate
      inputs:
        provider: 'azurerm'
        command: 'validate'
    
    - task: TerraformTaskV3@3
      displayName: Terraform destroy
      inputs:
        provider: 'azurerm'
        command: 'destroy'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
